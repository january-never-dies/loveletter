<!doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Prologue</title>
  <style>
    html,
    body {
      margin: 0;
      background: #fff;
      overflow-x: hidden;
      overscroll-behavior-y: none;
      -webkit-font-smoothing: antialiased;
    }

    /* 로딩 인디케이터 */
    #loading-overlay {
      position: fixed;
      inset: 0;
      z-index: 10000;
      background: #fff;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      transition: opacity 800ms ease-out, visibility 800ms;
    }

    #loading-overlay.fade-out {
      opacity: 0;
      visibility: hidden;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-top: 3px solid #000;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* 중앙 정렬 */
    .wrap {
      width: 100vw;
      display: flex;
      justify-content: center;
      background: #fff;
    }

    .frame {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background: #fff;
    }

    @supports (height: 100dvh) {
      .frame {
        height: 100dvh;
      }
    }

    .stage {
      position: absolute;
      inset: 0;
      width: 100%;
      transform: translateY(0);
      will-change: transform;
    }

    .layer {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      object-position: top center;

      opacity: 0;
      /* 메모리 최적화: 보이지 않을 때는 아예 렌더링 트레에서 제외 */
      visibility: hidden;
      transform: translate3d(0, 30px, 0);
      transition:
        opacity 1200ms cubic-bezier(0.25, 0.1, 0.25, 1),
        transform 1200ms cubic-bezier(0.25, 0.1, 0.25, 1);

      pointer-events: none;
      user-select: none;
      -webkit-user-drag: none;

      /* 이미지 선명도 보정 */
      image-rendering: -webkit-optimize-contrast;
      backface-visibility: hidden;
    }

    /* 버튼 레이어만 클릭 가능 */
    .layer[src*="button_go.webp"] {
      pointer-events: auto;
      cursor: pointer;
    }

    .layer.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
      /* 나타날 때만 will-change 적용하여 메모리 절약 */
      will-change: opacity, transform;
    }

    .spacer {
      width: 100%;
      background: #fff;
    }
  </style>
</head>

<body>
  <!-- 로딩 화면 -->
  <div id="loading-overlay">
    <div class="spinner"></div>
  </div>

  <div class="wrap" id="main-wrap">
    <div class="frame" id="frame">
      <div class="stage" id="stage">
        <!-- A-Series: a1-a13 -->
        <img class="layer" data-start="0" src="assets/a1.webp" alt="">
        <img class="layer" data-start="70" src="assets/a2.webp" alt="">
        <img class="layer" data-start="140" src="assets/a3.webp" alt="">
        <img class="layer" data-start="210" src="assets/a4.webp" alt="">
        <img class="layer" data-start="280" src="assets/a5.webp" alt="">
        <img class="layer" data-start="350" src="assets/a6.webp" alt="">
        <img class="layer" data-start="420" src="assets/a7.webp" alt="">
        <img class="layer" data-start="490" src="assets/a8.webp" alt="">
        <img class="layer" data-start="560" src="assets/a9.webp" alt="">
        <img class="layer" data-start="630" src="assets/a10.webp" alt="">
        <img class="layer" data-start="700" src="assets/a11.webp" alt="">
        <img class="layer" data-start="770" src="assets/a12.webp" alt="">
        <img class="layer" data-start="840" src="assets/a13.webp" alt="">

        <!-- B-Series: b1-b14 -->
        <img class="layer" data-start="950" src="assets/b1.webp" alt="">
        <img class="layer" data-start="1030" src="assets/b2.webp" alt="">
        <img class="layer" data-start="1110" src="assets/b3.webp" alt="">
        <img class="layer" data-start="1190" src="assets/b4.webp" alt="">
        <img class="layer" data-start="1270" src="assets/b5.webp" alt="">
        <img class="layer" data-start="1350" src="assets/b6.webp" alt="">
        <img class="layer" data-start="1430" src="assets/b7.webp" alt="">
        <img class="layer" data-start="1510" src="assets/b8.webp" alt="">
        <img class="layer" data-start="1590" src="assets/b9.webp" alt="">
        <img class="layer" data-start="1670" src="assets/b10.webp" alt="">
        <img class="layer" data-start="1750" src="assets/b11.webp" alt="">
        <img class="layer" data-start="1830" src="assets/b12.webp" alt="">
        <img class="layer" data-start="1910" src="assets/b13.webp" alt="">
        <img class="layer" data-start="1990" src="assets/b14.webp" alt="">

        <!-- Final Button -->
        <img class="layer" data-start="2100" src="assets/button_go.webp" alt="">
      </div>
    </div>
  </div>

  <div class="spacer" id="spacer"></div>

  <script>
    const CANVAS_W = 390;
    const CANVAS_H = 2912; // 원본 캔버스 높이
    const REVEAL_AT = 0.8;
    const LEAD = 50;

    const frame = document.getElementById('frame');
    const stage = document.getElementById('stage');
    const spacer = document.getElementById('spacer');
    const layers = Array.from(document.querySelectorAll('.layer'));
    const loadingOverlay = document.getElementById('loading-overlay');

    let MAX_TRANSLATE = 0;
    let viewHeight = 0;

    // 로딩 처리
    function hideLoading() {
      if (!loadingOverlay.classList.contains('fade-out')) {
        loadingOverlay.classList.add('fade-out');
      }
    }

    window.addEventListener('load', () => {
      // 리소스 로드 완료 후 약간의 여유를 두고 해제
      setTimeout(hideLoading, 300);
    });

    function layout() {
      // 모바일 브라우저 뷰포트 계산 안정화
      const frameW = frame.getBoundingClientRect().width;
      viewHeight = window.innerHeight; // frame.clientHeight 대신 실제 윈도우 높이 사용 고려

      const scaledStageH = frameW * (CANVAS_H / CANVAS_W);
      stage.style.height = scaledStageH + 'px';

      MAX_TRANSLATE = Math.max(0, scaledStageH - viewHeight);
      // spacer 높이를 조금 더 여유있게 설정하여 바닥 걸림 방지
      spacer.style.height = (Math.ceil(MAX_TRANSLATE) + viewHeight + 2) + 'px';

      const wrap = document.getElementById('main-wrap');
      wrap.style.position = 'fixed';
      wrap.style.top = '0';
      wrap.style.left = '0';
      wrap.style.width = '100%';
    }

    function updateScroll() {
      const y = window.pageYOffset || document.documentElement.scrollTop;
      const translateY = Math.min(y, MAX_TRANSLATE);
      // force hardware acceleration with translate3d
      stage.style.transform = `translate3d(0, ${-translateY}px, 0)`;

      const frameW = frame.clientWidth;
      const scale = frameW / CANVAS_W;
      const currentRevealY = (translateY + viewHeight * REVEAL_AT) / scale;

      for (const img of layers) {
        const start = Number(img.dataset.start || 0);
        if (start <= currentRevealY + LEAD) {
          img.classList.add('show');
        }
      }
    }

    function initEvents() {
      const btn = document.querySelector('.layer[src*="button_go.webp"]');
      if (btn) {
        btn.addEventListener('click', () => {
          window.location.href = 'sticker.html';
        });
      }
    }

    // Resize 시 스로틀링 및 주소창 변화 대응
    let resizeTimer;
    let lastWidth = window.innerWidth;
    window.addEventListener('resize', () => {
      // 가로 너비가 변한 경우에만 레이아웃 재계산 (주소창 숨김/노출로 인한 세로 변화 무시)
      if (window.innerWidth === lastWidth) return;
      lastWidth = window.innerWidth;

      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        layout();
        updateScroll();
      }, 100);
    });

    window.addEventListener('scroll', updateScroll, { passive: true });

    // 초기 실행 시점에 약간의 지연을 주어 브라우저 렌더링 안정화 후 계산
    window.addEventListener('DOMContentLoaded', () => {
      requestAnimationFrame(() => {
        layout();
        updateScroll();
        initEvents();
      });
    });

    // 혹시 모를 로딩 멈춤 방지 (1.5초 후 자동 해제)
    setTimeout(hideLoading, 1500);
  </script>
</body>

</html>