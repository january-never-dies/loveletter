<!doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Prologue</title>

  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      background: #fff;
      overscroll-behavior-y: none;
      -webkit-font-smoothing: antialiased;
    }

    #loading-overlay {
      position: fixed;
      inset: 0;
      z-index: 9999;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 14px;
      transition: opacity 300ms ease;
    }

    #loading-overlay.hide {
      opacity: 0;
      pointer-events: none;
    }

    #main-wrap {
      width: 100%;
      background: #fff;
    }

    #frame {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      overflow: hidden;
      background: #fff;
      touch-action: pan-y;
    }

    #stage {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      transform: translate3d(0, 0, 0);
    }

    .layer {
      /* ★ 수정: 캔버스 전체 너비에 맞게, 높이는 비율로 */
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: auto;

      opacity: 0;
      display: none;
      transform: translate3d(0, 30px, 0);

      transition:
        opacity 1000ms ease,
        transform 1000ms ease;

      pointer-events: none;
      user-select: none;
      -webkit-user-drag: none;
    }

    .layer.show {
      display: block;
      opacity: 1;
      transform: translate3d(0, 0, 0);
      will-change: opacity, transform;
      backface-visibility: hidden;
    }

    #goBtn {
      pointer-events: auto;
      cursor: pointer;
    }

    #spacer {
      width: 100%;
      height: 100vh;
    }
  </style>
</head>

<body>

  <div id="loading-overlay">Loading…</div>

  <div id="main-wrap">
    <div id="frame">
      <div id="stage">

        <!-- A -->
        <img class="layer" data-start="0"    data-src="assets/a1.webp">
        <img class="layer" data-start="70"   data-src="assets/a2.webp">
        <img class="layer" data-start="140"  data-src="assets/a3.webp">
        <img class="layer" data-start="210"  data-src="assets/a4.webp">
        <img class="layer" data-start="280"  data-src="assets/a5.webp">
        <img class="layer" data-start="350"  data-src="assets/a6.webp">
        <img class="layer" data-start="420"  data-src="assets/a7.webp">
        <img class="layer" data-start="490"  data-src="assets/a8.webp">
        <img class="layer" data-start="560"  data-src="assets/a9.webp">
        <img class="layer" data-start="630"  data-src="assets/a10.webp">
        <img class="layer" data-start="700"  data-src="assets/a11.webp">
        <img class="layer" data-start="770"  data-src="assets/a12.webp">
        <img class="layer" data-start="840"  data-src="assets/a13.webp">
        <img class="layer" data-start="910"  data-src="assets/a14.webp">

        <!-- B -->
        <img class="layer" data-start="980"  data-src="assets/b1.webp">
        <img class="layer" data-start="1060" data-src="assets/b2.webp">
        <img class="layer" data-start="1140" data-src="assets/b3.webp">
        <img class="layer" data-start="1220" data-src="assets/b4.webp">
        <img class="layer" data-start="1300" data-src="assets/b5.webp">
        <img class="layer" data-start="1380" data-src="assets/b6.webp">
        <img class="layer" data-start="1460" data-src="assets/b7.webp">
        <img class="layer" data-start="1540" data-src="assets/b8.webp">
        <img class="layer" data-start="1620" data-src="assets/b9.webp">
        <img class="layer" data-start="1700" data-src="assets/b10.webp">
        <img class="layer" data-start="1780" data-src="assets/b11.webp">
        <img class="layer" data-start="1860" data-src="assets/b12.webp">
        <img class="layer" data-start="1910" data-src="assets/b13.webp">
        <img class="layer" data-start="1990" data-src="assets/b14.webp">

        <img id="goBtn" class="layer" data-start="2100" data-src="assets/button_go.webp">
      </div>
    </div>

    <div id="spacer"></div>
  </div>

  <script>
    /* ===== 설정 ===== */
    const CANVAS_W = 390;
    const CANVAS_H = 2912;
    const REVEAL_AT = 0.6;       // ★ 0.8 → 0.6 : 더 일찍 트리거
    const LEAD = 80;             // ★ 50 → 80  : 더 여유 있게 표시
    const PRELOAD_AHEAD = 600;   // ★ 400 → 600: 미리 더 많이 로드
    const UNLOAD_BEHIND = 3000;  // ★ 1400 → 3000: iOS 크래시 방지, 덜 언로드

    /* ===== 요소 ===== */
    const frame   = document.getElementById('frame');
    const stage   = document.getElementById('stage');
    const spacer  = document.getElementById('spacer');
    const layers  = [...document.querySelectorAll('.layer')];
    const loading = document.getElementById('loading-overlay');

    let viewH = window.innerHeight;
    let maxTranslate = 0;

    /* ===== 레이아웃 ===== */
    function layout() {
      const w = frame.clientWidth;
      const scaledH = w * (CANVAS_H / CANVAS_W);

      stage.style.height = scaledH + 'px';
      maxTranslate = Math.max(0, scaledH - viewH);
      spacer.style.height = (maxTranslate + viewH + 2) + 'px';
    }

    /* ===== 이미지 관리 ===== */
    function load(img) {
      if (img.dataset.loaded) return;
      img.dataset.loaded = '1';
      img.src = img.dataset.src;
    }

    function unload(img) {
      if (!img.dataset.loaded) return;
      if (img.id === 'goBtn') return;
      // ★ src 제거 대신 display:none만 처리 → iOS Safari 재로드 크래시 방지
      img.classList.remove('show');
      img.style.display = 'none';
      // loaded 플래그는 유지(재다운로드 없음)
    }

    /* ===== 스크롤 ===== */
    function update() {
      const y = window.pageYOffset;
      const t = Math.min(y, maxTranslate);
      stage.style.transform = `translate3d(0, ${-t}px, 0)`;

      const scale  = frame.clientWidth / CANVAS_W;
      const revealY = (t + viewH * REVEAL_AT) / scale;

      for (const img of layers) {
        const start = +img.dataset.start;

        if (start <= revealY + PRELOAD_AHEAD) {
          load(img);
        }

        if (start <= revealY + LEAD && img.dataset.loaded) {
          img.style.display = 'block';
          img.offsetHeight; // force reflow
          img.classList.add('show');
        }

        if (start < revealY - UNLOAD_BEHIND) {
          unload(img);
        }
      }
    }

    /* ===== 이벤트 ===== */
    window.addEventListener('scroll', update, { passive: true });

    window.addEventListener('resize', () => {
      const newH = window.innerHeight;
      if (newH !== viewH) {
        viewH = newH;
        layout();
        update();
      }
    });

    document.getElementById('goBtn').onclick = () => {
      location.href = 'sticker.html';
    };

    window.addEventListener('load', () => {
      layout();
      update();
      setTimeout(() => loading.classList.add('hide'), 300);
    });
  </script>

</body>
</html>
