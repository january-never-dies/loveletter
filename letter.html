<!doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Letter to Me</title>
  <style>
    html,
    body {
      margin: 0;
      min-height: 100vh;
      background: #bcbabc;
      font-family: system-ui, -apple-system, "Apple SD Gothic Neo", sans-serif;
      overflow-x: hidden;
      overflow-y: auto;
    }

    * {
      box-sizing: border-box;
    }

    .frame {
      width: min(100vw, calc(100vh * (390/844)));
      min-height: 100vh;
      margin: auto;
      position: relative;
      background: #bcbabc;
    }

    .bg {
      display: block;
      width: 100%;
      height: auto;
      user-select: none;
      pointer-events: none;
    }

    .write-pad {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 45%;
      z-index: 10;
      pointer-events: none;
    }

    .pencil {
      position: absolute;
      bottom: 20px;
      right: 20px;
      width: 160px;
      cursor: grab;
      z-index: 20;
      touch-action: none;
      transition: transform 0.1s ease-out;
    }

    .pencil.dragging {
      cursor: grabbing;
      transition: none;
      z-index: 1001;
    }

    /* Modal Styles */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .overlay.open {
      display: flex;
      opacity: 1;
    }

    .modal {
      width: min(500px, 100%);
      background: #fff;
      border-radius: 24px;
      padding: 24px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      transform: translateY(20px);
      transition: transform 0.3s ease;
    }

    .overlay.open .modal {
      transform: translateY(0);
    }

    .modal-title {
      font-size: 20px;
      font-weight: 800;
      margin-bottom: 20px;
      text-align: center;
      color: #111;
    }

    .form-group {
      margin-bottom: 18px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 700;
      margin-bottom: 6px;
      color: #666;
    }

    .form-input,
    .form-textarea {
      width: 100%;
      padding: 12px 14px;
      border: 1.5px solid #eee;
      border-radius: 12px;
      font-size: 15px;
      font-family: inherit;
      outline: none;
      transition: border-color 0.2s;
    }

    .form-input:focus,
    .form-textarea:focus {
      border-color: #ffb7c5;
    }

    .form-textarea {
      height: 120px;
      resize: none;
    }

    .consent-group {
      display: flex;
      align-items: center;
      gap: 12px;
      background: #f9f9f9;
      padding: 12px;
      border-radius: 12px;
      margin-bottom: 24px;
    }

    .consent-label {
      flex: 1;
      font-size: 13px;
      line-height: 1.4;
      color: #444;
    }

    .toggle-btns {
      display: flex;
      background: #eee;
      padding: 2px;
      border-radius: 8px;
    }

    .toggle-btn {
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 700;
      border-radius: 6px;
      cursor: pointer;
      border: none;
      background: transparent;
      color: #888;
    }

    .toggle-btn.active {
      background: #fff;
      color: #000;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .submit-btn {
      width: 100%;
      padding: 16px;
      background: #000;
      color: #fff;
      border: none;
      border-radius: 14px;
      font-size: 16px;
      font-weight: 800;
      cursor: pointer;
      transition: transform 0.1s, opacity 0.2s;
    }

    .submit-btn:active {
      transform: scale(0.98);
      opacity: 0.9;
    }

    /* Success State */
    .success-content {
      text-align: center;
      padding: 20px 0;
      display: none;
    }

    .success-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .success-msg {
      font-size: 18px;
      font-weight: 700;
      color: #111;
      margin-bottom: 8px;
    }

    .success-sub {
      font-size: 14px;
      color: #666;
    }

    .form-notice {
      margin-top: 20px;
      font-size: 11px;
      line-height: 1.6;
      color: #999;
      text-align: left;
      word-break: keep-all;
    }

    .form-notice p {
      margin: 4px 0;
    }

    /* YouTube Responsive wrapper */
    .video-container {
      position: relative;
      padding-bottom: 56.25%;
      /* 16:9 */
      height: 0;
      overflow: hidden;
      border-radius: 14px;
      background: #000;
      margin-top: 20px;
    }

    .video-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: 0;
    }
  </style>
</head>

<body>

  <div class="frame">
    <img class="bg" src="assets/lt_bg.png" alt="">
    <img src="assets/lt_write.png" class="write-pad" id="pad" alt="">
    <img src="assets/lt_pencil.png" class="pencil" id="pencil" alt="Drag pencil to write">
  </div>

  <!-- Modal Overlay -->
  <div class="overlay" id="overlay">
    <div class="modal" id="modal">
      <div id="form-content">
        <div class="modal-title">ë§ˆìŒ ì „í•˜ê¸°</div>

        <div class="form-group">
          <label class="form-label">To. ë°›ëŠ” ì‚¬ëŒ</label>
          <input type="text" id="recipient" class="form-input" placeholder="ì¢‹ì•„í•˜ëŠ” í˜„ì„œì˜ ì• ì¹­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.">
        </div>

        <div class="form-group">
          <label class="form-label">í¸ì§€ ë‚´ìš©</label>
          <textarea id="message" class="form-textarea" placeholder="ë§ˆìŒì„ ì „í•´ë´…ì‹œë‹¤."></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">From. ë³´ë‚´ëŠ” ì‚¬ëŒ</label>
          <input type="text" id="sender" class="form-input" placeholder="ì„±í•¨ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. ë‹‰ë„¤ì„ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.">
        </div>

        <div class="form-group">
          <label class="form-label">ì½˜í…ì¸  í™œìš© ë™ì˜</label>
          <div class="consent-group">
            <span class="consent-label">ì¶”í›„ ì½˜í…ì¸  ì œì‘ ì‹œ ìµëª…ìœ¼ë¡œ í¸ì§€ ë‚´ìš©ì´ ê³µê°œë˜ëŠ” ê²ƒì— ë™ì˜í•˜ì‹œë‚˜ìš”?</span>
            <div class="toggle-btns">
              <button class="toggle-btn active" data-value="yes">YES</button>
              <button class="toggle-btn" data-value="no">NO</button>
            </div>
          </div>
        </div>

        <button id="submitBtn" class="submit-btn" disabled>ë³´ë‚´ê¸°</button>

        <div class="form-notice">
          <p>1. í¸ì§€ëŠ” ì—¬ëŸ¬ í†µ ì‘ì„± ë° ë°œì†¡í•  ìˆ˜ ìˆìœ¼ë‚˜, ë°œì†¡ í›„ ìˆ˜ì •ì€ ë¶ˆê°€í•©ë‹ˆë‹¤.</p>
          <p>2. ë©”ì‹œì§€ ë¶ì—ëŠ” ì—¬ëŸ¬ í†µì˜ í¸ì§€ë¥¼ ëª¨ë‘ ìˆ˜ë¡í•  ìˆ˜ ìˆìœ¼ë‚˜, ì‹¤ìˆ˜ë¡œ ì „ì†¡í–ˆìŒì´ ëª…í™•í•œ ê²½ìš°(í•œ ê¸€ìë§Œ ì…ë ¥ë¨ ë“±), ë‹¨ìˆœ ì˜¤íƒ€ ìˆ˜ì • ìˆ˜ì¤€ì˜ ì¤‘ë³µ ë‚´ìš©, ë¹„ë°©Â·ë¶€ì ì ˆí•œ ë‚´ìš©ì´ í¬í•¨ëœ ê²½ìš°ì—ëŠ”
            ì‚¬ì „ ì•ˆë‚´ ì—†ì´ ì‚­ì œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>
      </div>

      <div id="success-content" class="success-content">
        <div class="success-msg">ğŸ’Œ dear.ddwenty ğŸ’Œ</div>
        <div class="success-sub">í¸ì§€ê°€ ì†Œì¤‘íˆ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤!<br>ì‘ì„±í•´ì£¼ì‹  ë”°ëœ»í•œ ë§ˆìŒ ê°ì‚¬í•©ë‹ˆë‹¤.</div>
        <div class="video-container">
          <iframe src="https://www.youtube-nocookie.com/embed/oPq82FE91Ss?rel=0" title="YouTube video player"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
        </div>
        <button class="submit-btn" style="margin-top:24px;" onclick="location.reload()">Close</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK (always create new letter; no edit) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

    // Your Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBc-7tXKMNNPIeq2p7iCCpqPfBRNWbWbuU",
      authDomain: "loveletter-f763f.firebaseapp.com",
      projectId: "loveletter-f763f",
      storageBucket: "loveletter-f763f.firebasestorage.app",
      messagingSenderId: "47570140529",
      appId: "1:47570140529:web:720f45982941768daa0ad0"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Anonymous Sign-In
    signInAnonymously(auth).catch((error) => {
      console.error("Auth failed:", error);
    });

    let currentUser = null;
    onAuthStateChanged(auth, (user) => {
      if (user) currentUser = user;
    });

    (() => {
      const pencil = document.getElementById('pencil');
      const pad = document.getElementById('pad');
      const overlay = document.getElementById('overlay');
      const recipientInput = document.getElementById('recipient');
      const senderInput = document.getElementById('sender');
      const messageInput = document.getElementById('message');
      const submitBtn = document.getElementById('submitBtn');
      const toggleBtns = document.querySelectorAll('.toggle-btn');
      const formContent = document.getElementById('form-content');
      const successContent = document.getElementById('success-content');

      let consentValue = 'yes';
      let isDragging = false;
      let startX, startY;
      let initialLeft, initialTop;

      // Drag Logic
      const startDrag = (e) => {
        isDragging = true;
        pencil.classList.add('dragging');

        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;

        startX = clientX;
        startY = clientY;

        // Store computed styles for current position
        const style = window.getComputedStyle(pencil);
        const matrix = new WebKitCSSMatrix(style.transform);
        initialLeft = matrix.m41;
        initialTop = matrix.m42;

        // Store the origin position once
        if (typeof pencil.dataset.originX === 'undefined') {
          pencil.dataset.originX = initialLeft;
          pencil.dataset.originY = initialTop;
        }
      };

      const moveDrag = (e) => {
        if (!isDragging) return;
        e.preventDefault();

        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;

        const dx = clientX - startX;
        const dy = clientY - startY;

        pencil.style.transform = `translate(${initialLeft + dx}px, ${initialTop + dy}px)`;
      };

      const endDrag = () => {
        if (!isDragging) return;
        isDragging = false;
        pencil.classList.remove('dragging');

        const pencilRect = pencil.getBoundingClientRect();
        const padRect = pad.getBoundingClientRect();

        const isOver = !(pencilRect.right < padRect.left ||
          pencilRect.left > padRect.right ||
          pencilRect.bottom < padRect.top ||
          pencilRect.top > padRect.bottom);

        if (isOver) {
          overlay.classList.add('open');
          // Pencil stays where it was dropped
        } else {
          // Snap back
          pencil.style.transform = `translate(${pencil.dataset.originX}px, ${pencil.dataset.originY}px)`;
        }
      };

      pencil.addEventListener('mousedown', startDrag);
      window.addEventListener('mousemove', moveDrag);
      window.addEventListener('mouseup', endDrag);

      pencil.addEventListener('touchstart', startDrag, { passive: false });
      window.addEventListener('touchmove', moveDrag, { passive: false });
      window.addEventListener('touchend', endDrag);

      // Close Modal on outside click
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.classList.remove('open');
        }
      });

      // Consent Toggle
      toggleBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          toggleBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          consentValue = btn.dataset.value;
        });
      });

      // Validation
      const validate = () => {
        const canSubmit =
          recipientInput.value.trim().length > 0 &&
          senderInput.value.trim().length > 0 &&
          messageInput.value.trim().length > 0;
        submitBtn.disabled = !canSubmit;
      };

      recipientInput.addEventListener('input', validate);
      senderInput.addEventListener('input', validate);
      messageInput.addEventListener('input', validate);

      // Submit (ALWAYS create a new letter)
      submitBtn.addEventListener('click', async () => {
        if (!currentUser) {
          alert('ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
          return;
        }

        const letterData = {
          to: recipientInput.value.trim(),
          from: senderInput.value.trim(),
          content: messageInput.value.trim(),
          consent: consentValue,
          authorId: currentUser.uid,
          createdAt: serverTimestamp()
        };

        submitBtn.disabled = true;
        const originalText = submitBtn.innerText;
        submitBtn.innerText = 'ì €ì¥ ì¤‘...';

        try {
          await addDoc(collection(db, "letters"), letterData);

          formContent.style.display = 'none';
          successContent.style.display = 'block';
        } catch (e) {
          console.error('Failed to save letter:', e);
          alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
          submitBtn.disabled = false;
          submitBtn.innerText = originalText;
        }
      });
    })();
  </script>

</body>

</html>